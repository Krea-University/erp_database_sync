# Krea Onererp — Local DB Sync

Automates pulling a **Google Cloud SQL (MySQL)** production database down to a local Docker MySQL instance, creating application users from a JSON config, running your ERP app container, and keeping everything in sync every **2–3 hours** via cron.

---

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Project Structure](#project-structure)
- [Configuration](#configuration)
  - [Environment Variables](#environment-variables)
  - [MySQL Users JSON](#mysql-users-json)
  - [Sync Schedule](#sync-schedule)
- [Quick Start](#quick-start)
- [Scripts Reference](#scripts-reference)
  - [setup.sh](#setupsh)
  - [sync.sh](#syncsh)
- [Docker Compose](#docker-compose)
- [Credentials File](#credentials-file)
- [Logs & Backups](#logs--backups)
- [Troubleshooting](#troubleshooting)
- [Security Notes](#security-notes)

---

## Overview

```
Cloud SQL (Production)
        │
        │  Cloud SQL Auth Proxy (IAM-authenticated)
        ▼
   mysqldump ──► .sql.gz backup
        │
        ▼
Local Docker MySQL  ──►  App Container (ERP)
   (mysql_local)            (erp_app)
        │
        ▼
  cron: every 2 h
```

Every sync cycle:
1. Opens a secure tunnel to Cloud SQL via the **Cloud SQL Auth Proxy**
2. Dumps the production database with `mysqldump`
3. Restores the dump into the local Docker MySQL container
4. Keeps the last **10** backups and removes older ones

---

## Architecture

| Component | Technology |
|---|---|
| Production DB | Google Cloud SQL (MySQL 8) |
| Secure tunnel | Cloud SQL Auth Proxy v1 / v2 |
| Local DB | MySQL 8 in Docker |
| Orchestration | Docker Compose |
| User provisioning | Bash + `jq` (reads `MYSQL_USERS_JSON`) |
| Scheduling | `crontab` |
| Auth | GCP Service Account (JSON key) |

---

## Prerequisites

Install these tools before running anything:

| Tool | Install |
|---|---|
| Docker & Docker Compose | https://docs.docker.com/get-docker/ |
| `gcloud` CLI | https://cloud.google.com/sdk/docs/install |
| Cloud SQL Auth Proxy | https://cloud.google.com/sql/docs/mysql/sql-proxy |
| `mysqldump` (mysql-client) | `sudo apt install mysql-client` |
| `jq` | `sudo apt install jq` |

> **Windows users:** run these scripts inside **WSL 2** or **Git Bash**.

---

## Project Structure

```
erp_database_sync/
├── .env                  ← your local config (never commit)
├── .env.example          ← template — copy this to .env
├── .credentials.env      ← auto-generated by setup.sh (never commit)
├── docker-compose.yml    ← local MySQL service + Docker network
├── setup.sh              ← one-time setup script
├── sync.sh               ← sync script (also called by cron)
├── init/                 ← (optional) .sql files run on first MySQL start
└── README.md
```

---

## Configuration

### Environment Variables

Copy the template and fill in your values:

```bash
cp .env.example .env
```

| Variable | Description | Example |
|---|---|---|
| `CLOUD_SQL_INSTANCE` | Cloud SQL instance connection name | `myproject:us-central1:mydb` |
| `CLOUD_SQL_DB` | Production database name | `onererp_prod` |
| `CLOUD_SQL_USER` | Production DB user | `root` |
| `CLOUD_SQL_PASSWORD` | Production DB password | `s3cr3t` |
| `GOOGLE_APPLICATION_CREDENTIALS` | Path to GCP service account JSON key | `/secrets/sa-key.json` |
| `CLOUD_SQL_PROXY_PORT` | Local port for the proxy tunnel | `3307` |
| `MYSQL_ROOT_PASSWORD` | Local MySQL root password | `localroot` |
| `MYSQL_DATABASE` | Local database name (restored into) | `onererp_local` |
| `MYSQL_PORT` | Exposed MySQL port on host | `3306` |
| `MYSQL_USERS_JSON` | JSON array of users to create (see below) | — |
| `APP_DOCKER_IMAGE` | Docker image for the ERP app | `registry/onererp:latest` |
| `APP_CONTAINER_NAME` | Name for the app container | `erp_app` |
| `APP_PORT` | Port exposed by the app | `8080` |
| `DOCKER_NETWORK` | Docker network name | `erp_net` |
| `SYNC_INTERVAL_HOURS` | Cron interval in hours (`2` or `3`) | `2` |
| `SYNC_CRON_OVERRIDE` | Override with a custom cron expression | `0 */3 * * *` |
| `BACKUP_DIR` | Where `.sql.gz` dumps are stored | `/tmp/cloudsql_backups` |
| `LOG_DIR` | Where sync logs are written | `/var/log/erp_sync` |

---

### MySQL Users JSON

Define database users as a JSON array in `.env`. Each object supports:

| Field | Required | Description |
|---|---|---|
| `user` | Yes | MySQL username |
| `password` | Yes | User password |
| `host` | Yes | Allowed host (`%` = any, `localhost` = local only) |
| `privileges` | Yes | MySQL privilege string |
| `database` | No | Target database (defaults to `*` = all) |

**Example:**

```json
MYSQL_USERS_JSON='[
  {"user":"app_user",  "password":"AppP@ssw0rd!",  "host":"%",        "privileges":"ALL PRIVILEGES"},
  {"user":"readonly",  "password":"R3adOnly#2024",  "host":"localhost", "privileges":"SELECT"},
  {"user":"analytics", "password":"An@lytic$321",   "host":"%",        "privileges":"SELECT,SHOW VIEW",
   "database":"onererp_local"}
]'
```

Common privilege values:
- `ALL PRIVILEGES` — full access
- `SELECT` — read only
- `SELECT,INSERT,UPDATE,DELETE` — read/write, no schema changes
- `SELECT,SHOW VIEW` — read + view definitions

---

### Sync Schedule

| Setting | Behaviour |
|---|---|
| `SYNC_INTERVAL_HOURS=2` | Cron runs at `0 */2 * * *` (every 2 hours) |
| `SYNC_INTERVAL_HOURS=3` | Cron runs at `0 */3 * * *` (every 3 hours) |
| `SYNC_CRON_OVERRIDE=30 1,4,7 * * *` | Uses your exact cron expression, ignores interval |

---

## Quick Start

```bash
# 1. Clone / enter the project
cd erp_database_sync

# 2. Configure
cp .env.example .env
# Edit .env with your Cloud SQL details, passwords, and Docker image

# 3. Make scripts executable
chmod +x setup.sh sync.sh

# 4. Run one-time setup
./setup.sh
```

`setup.sh` will:
- Start local MySQL via Docker Compose
- Create all users from `MYSQL_USERS_JSON`
- Write `.credentials.env`
- Start your app container
- Register the cron job
- Run the first sync immediately

---

## Scripts Reference

### setup.sh

```
Usage: ./setup.sh
```

Runs once to bootstrap the entire environment. Safe to re-run — it is idempotent (containers are stopped/removed before recreation, duplicate cron entries are replaced).

**Steps performed:**

1. Load and validate `.env`
2. Check required CLI tools (`docker`, `jq`, `gcloud`, `mysqldump`, …)
3. `docker-compose up -d mysql_local` → wait for healthcheck
4. For each entry in `MYSQL_USERS_JSON`:
   - `CREATE USER IF NOT EXISTS`
   - `GRANT <privileges>`
   - `FLUSH PRIVILEGES`
5. Write `.credentials.env` with flat `DB_USER_N_*` variables
6. `docker run` the app image with `--env-file .credentials.env`
7. Register cron via `crontab`
8. Call `sync.sh` for the initial restore

---

### sync.sh

```
Usage: ./sync.sh          # manual run
       (called by cron)   # scheduled run
```

**Steps performed:**

1. Source `.env`
2. Activate GCP service account (`gcloud auth activate-service-account`)
3. Start Cloud SQL Auth Proxy in background
4. `mysqldump` production DB → compressed `dump_YYYYMMDD_HHMMSS.sql.gz`
5. `CREATE DATABASE IF NOT EXISTS` in local MySQL
6. Pipe dump into `mysql_local` container
7. Kill proxy (always, via `trap`)
8. Delete old backups beyond the last 10

---

## Docker Compose

[docker-compose.yml](docker-compose.yml) manages:

| Service | Container | Port |
|---|---|---|
| MySQL 8 | `mysql_local` | `${MYSQL_PORT}:3306` |

Volume `erp_mysql_data` persists MySQL data across container restarts.

Network `erp_net` connects MySQL and app containers so they resolve each other by container name (`MYSQL_HOST=mysql_local`).

**Useful commands:**

```bash
# Start MySQL only
docker-compose up -d mysql_local

# View MySQL logs
docker-compose logs -f mysql_local

# Stop everything
docker-compose down

# Destroy volumes (⚠ deletes local DB data)
docker-compose down -v
```

---

## Credentials File

`setup.sh` auto-generates `.credentials.env` — a flat env file passed to the app container:

```ini
MYSQL_HOST=mysql_local
MYSQL_PORT=3306
MYSQL_DATABASE=onererp_local
MYSQL_ROOT_PASSWORD=...
DB_USER_0_NAME=app_user
DB_USER_0_PASS=...
DB_USER_0_HOST=%
DB_USER_1_NAME=readonly
...
```

> This file is **auto-generated**. Do not edit it manually — re-run `setup.sh` to regenerate.

---

## Logs & Backups

| Path | Contents |
|---|---|
| `$LOG_DIR/sync_YYYYMMDD_HHMMSS.log` | Per-sync log (proxy, dump, restore output) |
| `$LOG_DIR/cron.log` | Aggregated cron stdout/stderr |
| `$BACKUP_DIR/dump_YYYYMMDD_HHMMSS.sql.gz` | Compressed SQL dumps (last 10 kept) |

**Tail live sync log:**
```bash
tail -f /var/log/erp_sync/cron.log
```

**List backups:**
```bash
ls -lh /tmp/cloudsql_backups/
```

**Manual restore from a specific backup:**
```bash
gunzip < /tmp/cloudsql_backups/dump_20240601_120000.sql.gz \
  | docker exec -i mysql_local mysql -uroot -p"$MYSQL_ROOT_PASSWORD" "$MYSQL_DATABASE"
```

---

## Troubleshooting

| Symptom | Fix |
|---|---|
| `cloud-sql-proxy not found` | Install the proxy binary and add to `$PATH` |
| `MySQL did not become ready` | Check `docker-compose logs mysql_local`; verify `MYSQL_ROOT_PASSWORD` |
| `Proxy PID died immediately` | Check `$LOG_DIR/sync_*.log`; verify `CLOUD_SQL_INSTANCE` format (`project:region:instance`) |
| `jq: command not found` | `sudo apt install jq` |
| `ERROR 1045: Access denied` | Check `CLOUD_SQL_USER` / `CLOUD_SQL_PASSWORD` in `.env` |
| Cron job not running | `crontab -l` — confirm entry exists; check `$LOG_DIR/cron.log` |
| App container exits immediately | `docker logs erp_app` — usually a missing env var or bad image tag |

---

## Security Notes

- **Never commit** `.env` or `.credentials.env` — add both to `.gitignore`
- Store the GCP service account JSON key outside the repo (e.g. `/secrets/`)
- Use **least-privilege** MySQL users — only grant `ALL PRIVILEGES` where truly needed
- The Cloud SQL Auth Proxy uses IAM-based authentication; no firewall rules needed
- Rotate `MYSQL_USERS_JSON` passwords regularly and re-run `setup.sh`

```bash
# Recommended .gitignore entries
echo ".env" >> .gitignore
echo ".credentials.env" >> .gitignore
echo "*.sql.gz" >> .gitignore
```

---

> Maintained by the **Krea Onererp** infrastructure team.
